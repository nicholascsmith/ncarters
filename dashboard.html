<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Dashboard</title>
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="/apple-touch-icon-180x180.png">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <main>
    <section>
      <a href="/" class="back-link">
        <svg viewBox="0 0 512.01 512.01" xmlns="http://www.w3.org/2000/svg">
          <path d="M505.756,475.589L286.171,256.005L505.755,36.421c6.101-6.101,7.936-15.275,4.629-23.253c-3.285-7.979-11.093-13.163-19.712-13.163H256.005c-5.675,0-11.093,2.24-15.083,6.251L6.256,240.922c-8.341,8.341-8.341,21.824,0,30.165l234.667,234.667c3.989,4.011,9.408,6.251,15.083,6.251h234.667c8.619,0,16.427-5.184,19.712-13.163C513.692,490.863,511.857,481.69,505.756,475.589z"/>
        </svg>
      </a>
      <h1>Dashboard</h1>

      <nav style="display: flex; gap: var(--space-md); margin: var(--space-lg) 0;">
        <button type="button" id="showUpload" style="width: auto; margin: 0;">Upload</button>
        <button type="button" id="showManage" style="width: auto; margin: 0;">Manage Posts</button>
      </nav>

  <form id="uploadForm">
    <div class="form-group">
      <label for="token">Password</label>
      <input type="password" id="token" required placeholder="Password">
    </div>

    <div class="form-group">
      <label for="photo">Photo</label>
      <input type="file" id="photo" accept="image/*" required>
      <img id="preview" class="preview hidden">
    </div>

    <div class="form-group">
      <label for="audio">Audio (MP3/M4A)</label>
      <input type="file" id="audio" accept="audio/mp3,audio/mpeg,audio/mp4,audio/x-m4a">
    </div>

    <div class="form-group">
      <label for="song">Song Title</label>
      <input type="text" id="song" placeholder="Song Title">
    </div>

    <div class="form-group">
      <label for="artist">Artist Name</label>
      <input type="text" id="artist" placeholder="Artist Name">
    </div>

    <button type="submit" id="submitBtn">Upload</button>
  </form>

  <div id="manageSection" style="display: none;">
    <div class="form-group">
      <label for="manageToken">Password</label>
      <input type="password" id="manageToken" placeholder="Password">
      <button type="button" id="loadPosts" style="margin-top: var(--space-md);">Load Posts</button>
    </div>
    <div id="postsList"></div>
  </div>
    </section>
  </main>

  <script>
    const GITHUB_USER = 'nicholascsmith';
    const GITHUB_REPO = 'ncarters';
    const GITHUB_API = 'https://api.github.com';

    const el = {
      form: document.getElementById('uploadForm'),
      photo: document.getElementById('photo'),
      audio: document.getElementById('audio'),
      token: document.getElementById('token'),
      song: document.getElementById('song'),
      artist: document.getElementById('artist'),
      submitBtn: document.getElementById('submitBtn'),
      preview: document.getElementById('preview')
    };

    function readFile(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    async function githubFetch(token, path, options = {}) {
      const response = await fetch(`${GITHUB_API}/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/${path}`, {
        ...options,
        headers: {
          'Authorization': `Bearer ${token}`,
          'Accept': 'application/vnd.github.v3+json',
          'Content-Type': 'application/json',
          ...options.headers
        }
      });

      if (!response.ok) {
        const error = await response.json().catch(() => ({}));
        throw new Error(error.message || `GitHub API error: ${response.status}`);
      }

      return response.json();
    }

    // Rate limiting - 10 second cooldown between uploads
    let lastUploadTime = 0;
    const UPLOAD_COOLDOWN = 10000; // 10 seconds

    // File size limits
    const MAX_PHOTO_SIZE = 10 * 1024 * 1024; // 10MB
    const MAX_AUDIO_SIZE = 15 * 1024 * 1024; // 15MB
    const MAX_TEXT_LENGTH = 500;

    el.photo.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (file) {
        if (file.size > MAX_PHOTO_SIZE) {
          alert('Photo must be under 10MB');
          el.photo.value = '';
          return;
        }
        el.preview.src = await readFile(file);
        el.preview.classList.remove('hidden');
      }
    });

    el.audio.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file && file.size > MAX_AUDIO_SIZE) {
        alert('Audio must be under 15MB');
        el.audio.value = '';
      }
    });

    el.form.addEventListener('submit', async (e) => {
      e.preventDefault();

      // Rate limiting check
      const now = Date.now();
      if (now - lastUploadTime < UPLOAD_COOLDOWN) {
        const secondsLeft = Math.ceil((UPLOAD_COOLDOWN - (now - lastUploadTime)) / 1000);
        alert(`Please wait ${secondsLeft} seconds before uploading again`);
        return;
      }

      const token = el.token.value;
      const photoFile = el.photo.files[0];
      const audioFile = el.audio.files[0];
      const song = el.song.value.slice(0, MAX_TEXT_LENGTH);
      const artist = el.artist.value.slice(0, MAX_TEXT_LENGTH);

      if (!photoFile) {
        alert('Please select a photo');
        return;
      }

      if (photoFile.size > MAX_PHOTO_SIZE) {
        alert('Photo must be under 10MB');
        return;
      }

      if (audioFile && audioFile.size > MAX_AUDIO_SIZE) {
        alert('Audio must be under 15MB');
        return;
      }

      el.submitBtn.disabled = true;

      try {
        // Step 1: Convert image to high-quality JPG
        el.submitBtn.innerHTML = '<span class="spinner"></span>Converting image to JPG';
        const jpgBlob = await convertToJPG(photoFile);

        // Step 2: Generate random filename
        const randomId = crypto.randomUUID().substring(0, 8);
        const filename = `photo${randomId}.jpg`;

        // Step 3: Convert to base64
        el.submitBtn.innerHTML = '<span class="spinner"></span>Preparing upload';
        const base64Data = await blobToBase64(jpgBlob);

        // Step 4: Handle audio file if provided
        let audioFilename = null;
        if (audioFile) {
          el.submitBtn.innerHTML = '<span class="spinner"></span>Processing audio file';
          const audioExt = audioFile.name.substring(audioFile.name.lastIndexOf('.') + 1).toLowerCase();
          const audioId = crypto.randomUUID().substring(0, 8);
          audioFilename = `audio${audioId}.${audioExt}`;
          const audioBase64 = await blobToBase64(audioFile);

          el.submitBtn.innerHTML = '<span class="spinner"></span>Uploading audio to GitHub';
          await uploadFile(token, `media/${audioFilename}`, audioBase64, ' Add audio track');
        }

        // Step 5: Upload JPG to GitHub first
        el.submitBtn.innerHTML = '<span class="spinner"></span>Uploading photo to GitHub';
        await uploadFile(token, `media/${filename}`, base64Data, ' Add new photo');

        // Step 6: Get current posts.json with SHA (after all file uploads)
        el.submitBtn.innerHTML = '<span class="spinner"></span>Reading posts.json';
        const { content: postsJson, sha: currentSha } = await getPostsJsonWithSha(token);

        // Step 7: Add new post entry
        const postEntry = { file: filename };
        if (song) postEntry.song = song;
        if (artist) postEntry.artist = artist;
        if (audioFilename) postEntry.audio = audioFilename;
        postsJson.push(postEntry);

        // Step 8: Update posts.json with the SHA we just got
        el.submitBtn.innerHTML = '<span class="spinner"></span>Updating posts.json';
        const postsJsonB64 = utf8ToBase64(JSON.stringify(postsJson, null, 2));
        await updatePostsJson(token, postsJsonB64, currentSha);

        // Success! Update rate limit timestamp
        lastUploadTime = Date.now();
        el.submitBtn.textContent = 'Success! Post will appear soon';

        // Clear token from memory
        el.token.value = '';

        el.form.reset();
        el.preview.classList.add('hidden');

        // Re-enable button after 5 seconds
        setTimeout(() => {
          el.submitBtn.disabled = false;
          el.submitBtn.textContent = 'Upload';
        }, 5000);

      } catch (error) {
        console.error(error);
        el.submitBtn.textContent = 'Upload failed - Try again';
        setTimeout(() => {
          el.submitBtn.disabled = false;
          el.submitBtn.textContent = 'Upload';
        }, 5000);
      }
    });

    // Convert any image format to high-quality JPG with smart resizing
    async function convertToJPG(file) {
      const dataUrl = await readFile(file);

      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');

          // Resize large images to max 1200px on longest side
          const MAX_SIZE = 1200;
          let width = img.width;
          let height = img.height;

          if (width > MAX_SIZE || height > MAX_SIZE) {
            if (width > height) {
              height = Math.round((height * MAX_SIZE) / width);
              width = MAX_SIZE;
            } else {
              width = Math.round((width * MAX_SIZE) / height);
              height = MAX_SIZE;
            }
          }

          canvas.width = width;
          canvas.height = height;

          const ctx = canvas.getContext('2d');
          ctx.fillStyle = '#FFFFFF';
          ctx.fillRect(0, 0, canvas.width, canvas.height);
          ctx.drawImage(img, 0, 0, width, height);

          canvas.toBlob(resolve, 'image/jpeg', 0.85);
        };
        img.onerror = reject;
        img.src = dataUrl;
      });
    }

    // Convert blob to base64
    async function blobToBase64(blob) {
      const dataUrl = await readFile(blob);
      return dataUrl.split(',')[1];
    }

    // Convert UTF-8 string to base64 (handles Unicode characters like Spanish accents)
    function utf8ToBase64(str) {
      return btoa(unescape(encodeURIComponent(str)));
    }

    // Get current posts.json with SHA from GitHub
    async function getPostsJsonWithSha(token) {
      try {
        const data = await githubFetch(token, 'posts.json');
        const content = atob(data.content.replace(/\n/g, ''));
        return { content: JSON.parse(content), sha: data.sha };
      } catch (error) {
        // If file doesn't exist, return empty array with null SHA
        return { content: [], sha: null };
      }
    }

    // Upload file to GitHub
    function uploadFile(token, path, base64Content, message) {
      return githubFetch(token, path, {
        method: 'PUT',
        body: JSON.stringify({ message, content: base64Content })
      });
    }

    // Update posts.json on GitHub with provided SHA
    function updatePostsJson(token, base64Content, sha) {
      return githubFetch(token, 'posts.json', {
        method: 'PUT',
        body: JSON.stringify({
          message: ' Update posts database',
          content: base64Content,
          sha
        })
      });
    }

    // Manage posts functionality
    const manageEl = {
      uploadForm: document.getElementById('uploadForm'),
      manageSection: document.getElementById('manageSection'),
      showUpload: document.getElementById('showUpload'),
      showManage: document.getElementById('showManage'),
      manageToken: document.getElementById('manageToken'),
      loadPosts: document.getElementById('loadPosts'),
      postsList: document.getElementById('postsList')
    };

    manageEl.showUpload.addEventListener('click', () => {
      manageEl.uploadForm.style.display = 'block';
      manageEl.manageSection.style.display = 'none';
    });

    manageEl.showManage.addEventListener('click', () => {
      manageEl.uploadForm.style.display = 'none';
      manageEl.manageSection.style.display = 'block';
    });

    manageEl.loadPosts.addEventListener('click', async () => {
      const token = manageEl.manageToken.value;
      if (!token) {
        alert('Please enter password');
        return;
      }

      manageEl.loadPosts.disabled = true;
      manageEl.loadPosts.textContent = 'Loading...';

      try {
        const { content: posts, sha } = await getPostsJsonWithSha(token);
        displayPosts(posts, token, sha);
      } catch (error) {
        alert('Failed to load posts');
        console.error(error);
      } finally {
        manageEl.loadPosts.disabled = false;
        manageEl.loadPosts.textContent = 'Load Posts';
      }
    });

    function displayPosts(posts, token, sha) {
      if (posts.length === 0) {
        manageEl.postsList.innerHTML = '<p>No posts found</p>';
        return;
      }

      manageEl.postsList.innerHTML = posts.reverse().map((post, index) => {
        const actualIndex = posts.length - 1 - index;
        return `
          <div style="border: 1px solid var(--text-dim); padding: var(--space-md); margin: var(--space-md) 0;">
            <img src="media/${post.file}" style="max-width: 200px; display: block; margin-bottom: var(--space-md); filter: grayscale(100%);">
            <p style="font-family: monospace; font-size: 0.9rem; margin-bottom: var(--space-md);">${post.file}</p>

            <div class="form-group">
              <label>Song Title</label>
              <input type="text" id="song-${actualIndex}" value="${post.song || ''}" placeholder="Song Title">
            </div>

            <div class="form-group">
              <label>Artist Name</label>
              <input type="text" id="artist-${actualIndex}" value="${post.artist || ''}" placeholder="Artist Name">
            </div>

            <div class="form-group">
              <label>Audio Track${post.audio ? ' (current: ' + post.audio + ')' : ''}</label>
              <input type="file" id="audio-${actualIndex}" accept="audio/mp3,audio/mpeg,audio/mp4,audio/x-m4a">
            </div>

            <div style="display: flex; gap: var(--space-sm);">
              <button onclick="updatePost(${actualIndex}, '${token}', '${sha}')" style="width: auto; margin: 0;">Save</button>
              <button onclick="deletePost(${actualIndex}, '${token}', '${sha}')" style="width: auto; margin: 0; background: #dc2626; color: #fff;">Delete</button>
            </div>
          </div>
        `;
      }).join('');
    }

    async function updatePost(index, token, sha) {
      const song = document.getElementById(`song-${index}`).value;
      const artist = document.getElementById(`artist-${index}`).value;
      const audioFile = document.getElementById(`audio-${index}`).files[0];

      try {
        const { content: posts } = await getPostsJsonWithSha(token);

        // Handle new audio file upload
        if (audioFile) {
          if (audioFile.size > MAX_AUDIO_SIZE) {
            alert('Audio must be under 15MB');
            return;
          }

          // Delete old audio if exists
          if (posts[index].audio) {
            await deleteFile(token, `media/${posts[index].audio}`);
          }

          // Upload new audio
          const audioExt = audioFile.name.substring(audioFile.name.lastIndexOf('.') + 1).toLowerCase();
          const audioId = crypto.randomUUID().substring(0, 8);
          const audioFilename = `audio${audioId}.${audioExt}`;
          const audioBase64 = await blobToBase64(audioFile);

          await uploadFile(token, `media/${audioFilename}`, audioBase64, ' Update audio track');
          posts[index].audio = audioFilename;
        }

        posts[index].song = song || undefined;
        posts[index].artist = artist || undefined;

        // Remove undefined fields
        if (!posts[index].song) delete posts[index].song;
        if (!posts[index].artist) delete posts[index].artist;

        const postsJsonB64 = utf8ToBase64(JSON.stringify(posts, null, 2));
        await updatePostsJson(token, postsJsonB64, sha);

        alert('Post updated successfully');
        manageEl.loadPosts.click(); // Reload posts
      } catch (error) {
        alert('Failed to update post');
        console.error(error);
      }
    }

    async function deletePost(index, token, sha) {
      if (!confirm('Are you sure you want to delete this post? This cannot be undone.')) {
        return;
      }

      try {
        const { content: posts } = await getPostsJsonWithSha(token);
        const post = posts[index];

        // Delete media files
        if (post.file) {
          await deleteFile(token, `media/${post.file}`);
        }
        if (post.audio) {
          await deleteFile(token, `media/${post.audio}`);
        }

        // Remove from posts array
        posts.splice(index, 1);

        const postsJsonB64 = utf8ToBase64(JSON.stringify(posts, null, 2));
        await updatePostsJson(token, postsJsonB64, sha);

        alert('Post deleted successfully');
        manageEl.loadPosts.click(); // Reload posts
      } catch (error) {
        alert('Failed to delete post');
        console.error(error);
      }
    }

    async function deleteFile(token, path) {
      const data = await githubFetch(token, path);
      return githubFetch(token, path, {
        method: 'DELETE',
        body: JSON.stringify({
          message: ' Delete file',
          sha: data.sha
        })
      });
    }
  </script>
</body>
</html>
